<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1ck7ag0" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.22.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.19.0">
  <bpmn:process id="Process_00k3z3e" name="processino" isExecutable="true">
    <bpmn:startEvent id="Receive_Req" name="Receive Req">
      <bpmn:outgoing>Flow_11l3dtn</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_1gsk3ey" messageRef="Message_0efptq9" />
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_11l3dtn" sourceRef="Receive_Req" targetRef="Activity_0lxfs5l" />
    <bpmn:serviceTask id="Activity_0lxfs5l" name="get userData">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">http://localhost:9080/user/${clientData.username}</camunda:inputParameter>
            <camunda:inputParameter name="method">GET</camunda:inputParameter>
            <camunda:outputParameter name="userData">${billpostingService.unmarshallUserData(JSON(response))}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_11l3dtn</bpmn:incoming>
      <bpmn:outgoing>Flow_1m6i1ra</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Activity_1nqxpot" name="get zoneList">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">http://localhost:9090/zones/${clientData.format}</camunda:inputParameter>
            <camunda:inputParameter name="method">GET</camunda:inputParameter>
            <camunda:outputParameter name="zoneListJson">${JSON(response)}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
        <camunda:inputOutput>
          <camunda:outputParameter name="zoneList">${billpostingService.unmarshallZoneListFiltered(zoneListJson,clientData)}</camunda:outputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1m6i1ra</bpmn:incoming>
      <bpmn:outgoing>Flow_0y537jr</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_1m6i1ra" sourceRef="Activity_0lxfs5l" targetRef="Activity_1nqxpot" />
    <bpmn:sequenceFlow id="Flow_0y537jr" sourceRef="Activity_1nqxpot" targetRef="Activity_1ed8i0x" />
    <bpmn:intermediateCatchEvent id="Event_2" name="Send Decision">
      <bpmn:incoming>Flow_01d8j69</bpmn:incoming>
      <bpmn:incoming>Flow_0sv6e6o</bpmn:incoming>
      <bpmn:outgoing>Flow_1q6lwkg</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_12x36a5" messageRef="Message_3k7e0e9" />
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="Flow_01d8j69" sourceRef="Activity_1ed8i0x" targetRef="Event_2" />
    <bpmn:exclusiveGateway id="Gateway_1jl3sd3" name="decision evaluator" default="Flow_1gsd6m7">
      <bpmn:incoming>Flow_1q6lwkg</bpmn:incoming>
      <bpmn:outgoing>Flow_1orgb70</bpmn:outgoing>
      <bpmn:outgoing>Flow_1ijiksr</bpmn:outgoing>
      <bpmn:outgoing>Flow_1gsd6m7</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_1q6lwkg" sourceRef="Event_2" targetRef="Gateway_1jl3sd3" />
    <bpmn:sequenceFlow id="Flow_1orgb70" sourceRef="Gateway_1jl3sd3" targetRef="Activity_1tpc3qv">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${decision == "confirm"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1ijiksr" sourceRef="Gateway_1jl3sd3" targetRef="Activity_0tuhqnd">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${decision == "cancel"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:endEvent id="Event_1ex2h4i">
      <bpmn:incoming>Flow_0oevdgh</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:endEvent id="Event_04utopo">
      <bpmn:incoming>Flow_1rj84r3</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0mu7925" sourceRef="Activity_0tuhqnd" targetRef="Activity_1hnuuii" />
    <bpmn:sequenceFlow id="Flow_1rj84r3" sourceRef="Activity_1hnuuii" targetRef="Event_04utopo" />
    <bpmn:scriptTask id="Activity_1hnuuii" name="print_empty_response" scriptFormat="javascript">
      <bpmn:incoming>Flow_0mu7925</bpmn:incoming>
      <bpmn:outgoing>Flow_1rj84r3</bpmn:outgoing>
      <bpmn:script>java.lang.System.out.println("Cancellation notice !!")</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_0oevdgh" sourceRef="Activity_0urg9dd" targetRef="Event_1ex2h4i" />
    <bpmn:serviceTask id="Activity_0urg9dd" name="print to file" camunda:delegateExpression="${writerDelegate}">
      <bpmn:incoming>Flow_12oew59</bpmn:incoming>
      <bpmn:outgoing>Flow_0oevdgh</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_173tt7h" sourceRef="Activity_1tpc3qv" targetRef="Activity_1a8kmne" />
    <bpmn:sequenceFlow id="Flow_12oew59" sourceRef="Activity_1a8kmne" targetRef="Activity_0urg9dd" />
    <bpmn:scriptTask id="Activity_1a8kmne" name="set vars" scriptFormat="javascript">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="content">
            <camunda:script scriptFormat="freemarker" resource="deployment://file_template.ftl" />
          </camunda:inputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_173tt7h</bpmn:incoming>
      <bpmn:outgoing>Flow_12oew59</bpmn:outgoing>
      <bpmn:script>execution.setVariable("contentToWrite", content);
execution.setVariable("filePath", "testi\\file_"+requestId+".txt");</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:serviceTask id="Activity_1tpc3qv" name="confirm">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">http://localhost:8888/postingservice</camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="freemarker" resource="deployment://conf.ftl" />
            </camunda:inputParameter>
            <camunda:outputParameter name="accountHolder">${XML(response).childElement("Body").childElement("http://disim.univaq.it/services/postingservice","confirmationResponse").childElement("bill").childElement("accountHolder").textContent()}</camunda:outputParameter>
            <camunda:outputParameter name="amountDue">${XML(response).childElement("Body").childElement("http://disim.univaq.it/services/postingservice","confirmationResponse").childElement("bill").childElement("amountDue").textContent()}</camunda:outputParameter>
            <camunda:outputParameter name="invoiceNumber">${XML(response).childElement("Body").childElement("http://disim.univaq.it/services/postingservice","confirmationResponse").childElement("bill").childElement("invoiceNumber").textContent()}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>soap-http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1orgb70</bpmn:incoming>
      <bpmn:outgoing>Flow_173tt7h</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Activity_0tuhqnd" name="cancel">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">http://localhost:8888/postingservice</camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="freemarker" resource="deployment://canc.ftl" />
            </camunda:inputParameter>
            <camunda:outputParameter name="empty_res">${response}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>soap-http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1ijiksr</bpmn:incoming>
      <bpmn:outgoing>Flow_0mu7925</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_1gsd6m7" sourceRef="Gateway_1jl3sd3" targetRef="Activity_1mldtgi" />
    <bpmn:scriptTask id="Activity_1mldtgi" name="invalid dec" scriptFormat="javascript">
      <bpmn:incoming>Flow_1gsd6m7</bpmn:incoming>
      <bpmn:outgoing>Flow_0sv6e6o</bpmn:outgoing>
      <bpmn:script>java.lang.System.out.println("Invalid decision, try with 'confirm' or 'cancel' ")</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_0sv6e6o" sourceRef="Activity_1mldtgi" targetRef="Event_2" />
    <bpmn:serviceTask id="Activity_1ed8i0x" name="Check Availability">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">http://localhost:8888/postingservice</camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="freemarker" resource="deployment://postingserviceavailability.ftl" />
            </camunda:inputParameter>
            <camunda:outputParameter name="requestId">${XML(response).childElement("Body").childElement("http://disim.univaq.it/services/postingservice","availabilityResponse").childElement("requestId").textContent()}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>soap-http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0y537jr</bpmn:incoming>
      <bpmn:outgoing>Flow_01d8j69</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:textAnnotation id="TextAnnotation_0uxw195" />
    <bpmn:association id="Association_1svhzp6" associationDirection="None" sourceRef="Gateway_1jl3sd3" targetRef="TextAnnotation_0uxw195" />
  </bpmn:process>
  <bpmn:message id="Message_0efptq9" name="req" />
  <bpmn:message id="Message_3k7e0e9" name="decision" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_00k3z3e">
      <bpmndi:BPMNShape id="Event_1x3qgp9_di" bpmnElement="Receive_Req">
        <dc:Bounds x="162" y="322" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="149" y="365" width="64" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1uv7ozy_di" bpmnElement="Activity_0lxfs5l">
        <dc:Bounds x="280" y="300" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0379frw" bpmnElement="Activity_1nqxpot">
        <dc:Bounds x="470" y="300" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1w1p24z_di" bpmnElement="Event_2">
        <dc:Bounds x="812" y="322" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="794" y="365" width="72" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1jl3sd3_di" bpmnElement="Gateway_1jl3sd3" isMarkerVisible="true">
        <dc:Bounds x="915" y="315" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="765" y="448" width="90" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1ex2h4i_di" bpmnElement="Event_1ex2h4i">
        <dc:Bounds x="1302" y="222" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_04utopo_di" bpmnElement="Event_04utopo">
        <dc:Bounds x="1302" y="412" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1j1tmee_di" bpmnElement="Activity_1hnuuii">
        <dc:Bounds x="1170" y="390" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0b2fv0p_di" bpmnElement="Activity_0urg9dd">
        <dc:Bounds x="1170" y="200" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_195dj1m_di" bpmnElement="Activity_1a8kmne">
        <dc:Bounds x="1100" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0gwne83_di" bpmnElement="Activity_1tpc3qv">
        <dc:Bounds x="1030" y="200" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0vdyrnd_di" bpmnElement="Activity_0tuhqnd">
        <dc:Bounds x="1030" y="390" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ey8juw_di" bpmnElement="Activity_1mldtgi">
        <dc:Bounds x="1030" y="300" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1einv0x_di" bpmnElement="Activity_1ed8i0x">
        <dc:Bounds x="650" y="300" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="TextAnnotation_0uxw195_di" bpmnElement="TextAnnotation_0uxw195">
        <dc:Bounds x="760" y="440" width="100" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_11l3dtn_di" bpmnElement="Flow_11l3dtn">
        <di:waypoint x="198" y="340" />
        <di:waypoint x="280" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1m6i1ra_di" bpmnElement="Flow_1m6i1ra">
        <di:waypoint x="380" y="340" />
        <di:waypoint x="470" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0y537jr_di" bpmnElement="Flow_0y537jr">
        <di:waypoint x="570" y="340" />
        <di:waypoint x="650" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_01d8j69_di" bpmnElement="Flow_01d8j69">
        <di:waypoint x="750" y="340" />
        <di:waypoint x="812" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1q6lwkg_di" bpmnElement="Flow_1q6lwkg">
        <di:waypoint x="848" y="340" />
        <di:waypoint x="915" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1orgb70_di" bpmnElement="Flow_1orgb70">
        <di:waypoint x="940" y="315" />
        <di:waypoint x="940" y="240" />
        <di:waypoint x="1030" y="240" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1ijiksr_di" bpmnElement="Flow_1ijiksr">
        <di:waypoint x="940" y="365" />
        <di:waypoint x="940" y="430" />
        <di:waypoint x="1030" y="430" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0mu7925_di" bpmnElement="Flow_0mu7925">
        <di:waypoint x="1130" y="430" />
        <di:waypoint x="1170" y="430" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1rj84r3_di" bpmnElement="Flow_1rj84r3">
        <di:waypoint x="1270" y="430" />
        <di:waypoint x="1302" y="430" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0oevdgh_di" bpmnElement="Flow_0oevdgh">
        <di:waypoint x="1270" y="240" />
        <di:waypoint x="1302" y="240" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_173tt7h_di" bpmnElement="Flow_173tt7h">
        <di:waypoint x="1120" y="200" />
        <di:waypoint x="1120" y="160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_12oew59_di" bpmnElement="Flow_12oew59">
        <di:waypoint x="1190" y="160" />
        <di:waypoint x="1190" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1gsd6m7_di" bpmnElement="Flow_1gsd6m7">
        <di:waypoint x="965" y="340" />
        <di:waypoint x="1030" y="340" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0sv6e6o_di" bpmnElement="Flow_0sv6e6o">
        <di:waypoint x="1130" y="340" />
        <di:waypoint x="1370" y="340" />
        <di:waypoint x="1370" y="50" />
        <di:waypoint x="830" y="50" />
        <di:waypoint x="830" y="322" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Association_1svhzp6_di" bpmnElement="Association_1svhzp6">
        <di:waypoint x="927" y="352" />
        <di:waypoint x="827" y="440" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
